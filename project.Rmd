---
title: "Эконометрика (Econometrics)"
author: "Vladimír Tomeček"
date: "04/29/2015"
output: html_document
---

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(printr)
library(knitr)
```

### Предупреждение
В следующем тексте могут появляться грамматические ошибки. Это потому что Русский мой четвертый язык. Простите пожалуйста.

### Загрузка данных
Для загрузки данных мы используем пакет `rlms` от Бориса Демешева.

```{r message=FALSE, warning=FALSE}
library(rlms)
setwd('/home/vlado/mooc/econometrics/')
data = read.rlms('r22i_os25a.sav', suppress=TRUE)
```


### Выбор переменных

Для зарплаты мы используем `rj13.2`, потому что он характеризует среднемесячную зарплату, более устойчивую к случайным колебаниям, чем `rj10`, который показывает доход за последние 30 дней.

В виде регрессоров мы используем переменные `rh6` (год рождения), `rh5` (пол), `r_diplom` (образование),
`popul` (численность населения) i `rj6.2` (длительность рабочей недели).

Из года рождения мы вычисляем возраст. Он бы должен иметь позитивное влияние на зарплату,
потому что он корелирован с опытом работы.
Но у очень старых людей предпологою негативное влияние.

Думаю что женщины будут имеет низшую зарплату чем мужчины, потому что они чаще прерывают карьеру
из-за детей и у них нет готовности к сверхурочней работе, ночным сменам и опасным работам.

Образование будет имеет позитивное влияние, чем больше образования  тем лучше,
потому что образование позволяет быть более продуктивным.

Численность населения будет имеет позитивное влияние. 
В больших городах более служеб, более рабочих мест, низшая безработица, вышшая квартплата,
потому и большие зарплаты.

Ну и наконец длительность рабочего времени будет тоже имеет позитивное влияние на зарплату. 
Предполагаю, что сотрудники работающий более часов получают большую зарплату, иначе бы они так много не работали.

Думаю что наиболее влияния иметь профессия (`rj2cod08`), но насколько мы имеем только 6000 наблюдений со зарплатов
и профессии 572, там риск оверфиттинга. Потому я решил ее неиспользовать.

Очень большое влияние будет точно имеет и `region`, но это тоже категорическая переменная
с множеством левелов, потому я решил использовать в место него переменную `popul`.



### Очистка данных

Чтобы не работать с огромным массивом мы сперву используем пакет `dplyr` для выбора только нам нужных переменных.
Затем мы очистим данные от пропущенных наблюдении и даем нашим переменним более приятные имена.

Потом мы вычислим переменную возраст из переменой год рождения и трансформируем
категорическую переменную пол на integer, чтобы мы могли использовать команду describe.

И наконец мы трансформируем переменную образование на 4 фиктивных переменных:

- Незаконченное среднее образование (категории от 1 до 3)
- Законченное среднее образование (категория 4)
- Законченное среднее специальное образование (категория 5)
- Законченное высшее образование (категория 6)

```{r message=FALSE, warning=FALSE}
# rj13.2 - заработная плата
# rh6 - возраст
# rh5 - пол 
# r_diplom - образование
# popul - ЧИСЛЕННОСТЬ НАСЕЛЕНИЯ 
# rj6.2 - Сколько часов в среднем продолжается Ваша обычная рабочая неделя?

library(dplyr)
library(plyr)

# select only interesting columns
data2 <- dplyr::select(data, rj13.2, rh6, rh5, r_diplom, popul, rj6.2)

# omit NAs
data2 <- na.omit(data2)
data2 <- data2[-(data2$r_diplom == "НЕТ ОТВЕТА"),]

# rename columns
data2 <- plyr::rename(data2, c("rj13.2"="salary", "rh6"="age", "rh5"="sex", "r_diplom"="education",
                               "popul"="population", "rj6.2"="hours"))

# calculate age
data2$age <- 2013 -data2$age

# refactor sex
data2$sex <- as.integer(data2$sex == "МУЖСКОЙ")

# refactor education to 4 categories only
data2$education <- plyr::mapvalues(data2$education,
    from = c("окончил 0 - 6 классов", "незаконч среднее образование (7 - 8 кл)",
             "незаконч среднее образование (7 - 8 кл) + что-то еще"),
    to = rep("незаконч среднее образование", 3)
)
data2$edu1 <- as.integer(data2$education == "незаконч среднее образование")
data2$edu2 <- as.integer(data2$education == "законч среднее образование")
data2$edu3 <- as.integer(data2$education == "законч среднее специальное образование")
data2$edu4 <- as.integer(data2$education == "законч высшее образование и выше")
data2$education <- NULL
```


### таблица с описательными статистиками

Для построения таблицы с описательными статистиками используем команду `describe`,
столбцы skew нам не надо.
```{r message=FALSE, warning=FALSE}
library(psych)
describe(data2, skew=FALSE, ranges=TRUE)
```



### Гистограммы

Для построения графиков, мы используем пакет `ggplot2`.
```{r message=FALSE, warning=FALSE}
library(ggplot2)
qplot(data2$salary, xlab="зарплата")
```

Зарплата имеет экспоненциальное распределение.

```{r message=FALSE, warning=FALSE}
qplot(data2$age, xlab="возраст")
```

Возраст имеет примерно униформные распределенные между 20-60 a потом экспоненциальное.


### Построение модели

Построим простую линейную регрессию заработной платы на возраст, пол, 
3 фиктивные переменные на образование (за базовую категорию мы выбрали самый низкий уровень образования),
логаритм численности населения и длительность рабочего времени.

```{r message=FALSE, warning=FALSE, results='hide'}
library(lmtest)
model <- lm(salary ~ age + sex + log(population) + hours + edu2 + edu3 + edu4, data=data2)
coeftest(model)
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
s = summary(model)
kable(s$coef)
```

Все переменные значимы на 5% уровне значимости и даже меньшом.

Каждый год возрасту убирает 62 рублей со зарплаты (только в линейней модели, я предпологаю нелинейно зависимость).

Мужчины зарабатывают в среднем о 7380 рублей более чем женщины при одинаковом образовании,
в одинаковом городе с одинаковом возрастом, при одинаковей длительности рабочей недели.

С ростом численности населения в 2.71 раза, зарплата увеличивается о 1277 рублей,
при одинаковых остальных показателях.

С каждым отработаным часом в неделю зарплата увеличается о 163 рублей.

Сотрудники  закончавшие среднее образование зарабатывают в среднем о 2118 рублей более чем те,
которые его не закончали. Если закончили среднее специальное образование то зарабатывают вдобавок 2462 рублей и
закончившие высшее образование и выше получают еще о 5877 более против сотрудником закончившим только среднее специальное образование.



### Модель с робастными ошибками
```{r message=FALSE, warning=FALSE, results='hide'}
library(sandwich)
coeftest(model, vcov. = vcovHAC(model))
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
s = summary(model)
c = coeftest(model, vcov. = vcovHAC(model))
s$coef[,2:4] = c[,2:4]
kable(s$coef)
```

Опять все переменные значимы на 5% уровне значимости, но стандартные ошибки поменялись а
также t-статистики и P-значения, потому что они зависиме на стандардных ошибках.

Стандардные ошибки отличаются потому что они вычисляются с помощью другей формулы.
Робастные ошибки мы используем когда предполагаем наличие автокореляции.



